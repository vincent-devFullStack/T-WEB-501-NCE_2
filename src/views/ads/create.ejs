<link rel="stylesheet" href="/style/create.css" />

<main class="create-container">
  <header class="create-header">
    <h1>Créer une offre d'emploi</h1>
  </header>

  <% if (!userHasCompany) { %>
    <div class="banner-warn">
      Votre compte n'est rattaché à aucune entreprise.
      <form id="quick-company" style="display:inline-flex; gap:.5rem; margin-left:.5rem">
        <input name="company_name" required placeholder="Nom de l'entreprise" />
        <button class="btn btn-secondary" type="submit">Enregistrer</button>
      </form>
    </div>
    <script>
      document.getElementById('quick-company')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const r = await fetch('/api/account/company', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ company_name: fd.get('company_name') })
        });
        if (r.ok) location.reload();
        else alert('Impossible d\'attacher l\'entreprise.');
      });
    </script>
  <% } %>

  <p class="hint">Les champs marqués d'un * sont obligatoires.</p>

  <form id="create-ad-form" action="/ads" method="post" novalidate>
    <!-- Entreprise affichée à titre informatif -->
    <div class="readonly-line">
      <span class="label">Entreprise</span>
      <span class="value"><%= companyName || '—' %></span>
    </div>

    <div class="form-grid">
      <!-- Intitulé & localisation -->
      <div class="field full">
        <label for="job_title">Titre du poste *</label>
        <input
          type="text"
          id="job_title"
          name="job_title"
          maxlength="255"
          required
          placeholder="Développeur·se Full-stack JavaScript"
        />
      </div>

      <div class="field full">
        <label for="location">Localisation</label>
        <input
          type="text"
          id="location"
          name="location"
          maxlength="255"
          placeholder="Paris, Lyon, Remote…"
        />
      </div>

      <!-- Descriptions -->
      <div class="field full">
        <label for="job_description">Description du poste</label>
        <textarea
          id="job_description"
          name="job_description"
          placeholder="Missions, contexte, équipe, outils…"
        ></textarea>
      </div>

      <div class="field full">
        <label for="requirements">Besoins / Pré-requis</label>
        <textarea
          id="requirements"
          name="requirements"
          placeholder="Compétences techniques et soft skills attendues…"
        ></textarea>
      </div>

      <!-- Paramètres -->
      <div class="field">
        <label for="contract_type">Type de contrat *</label>
        <select id="contract_type" name="contract_type" required>
          <option value="cdi" selected>CDI</option>
          <option value="cdd">CDD</option>
          <option value="interim">Intérim</option>
          <option value="stage">Stage</option>
          <option value="alternance">Alternance</option>
          <option value="freelance">Freelance</option>
        </select>
      </div>

      <div class="field">
        <label for="working_time">Temps de travail</label>
        <select id="working_time" name="working_time">
          <option value="temps_plein" selected>Temps plein</option>
          <option value="temps_partiel">Temps partiel</option>
        </select>
      </div>

      <div class="field">
        <label for="experience_level">Niveau d'expérience</label>
        <select id="experience_level" name="experience_level">
          <option value="non_precise" selected>Non précisé</option>
          <option value="debutant">Débutant</option>
          <option value="intermediaire">Intermédiaire</option>
          <option value="confirme">Confirmé</option>
          <option value="expert">Expert</option>
        </select>
      </div>

      <div class="field">
        <label for="remote_option">Télétravail</label>
        <select id="remote_option" name="remote_option">
          <option value="non" selected>Non</option>
          <option value="hybride">Hybride</option>
          <option value="full_remote">Télétravail</option>
        </select>
      </div>

      <!-- Salaire -->
      <div class="field">
        <label for="salary_min">Salaire minimum</label>
        <input type="number" id="salary_min" name="salary_min" min="0" step="500" placeholder="Ex. 35000" />
      </div>

      <div class="field">
        <label for="salary_max">Salaire maximum</label>
        <input type="number" id="salary_max" name="salary_max" min="0" step="500" placeholder="Ex. 45000" />
      </div>

      <div class="field">
        <label for="currency">Monnaie</label>
        <select id="currency" name="currency">
          <option value="EUR" selected>EUR (€)</option>
          <option value="USD">USD ($)</option>
          <option value="GBP">GBP (£)</option>
        </select>
      </div>

      <!-- Deadline & statut -->
      <div class="field">
        <label for="deadline_date">Date limite</label>
        <input type="date" id="deadline_date" name="deadline_date" />
      </div>

      <div class="field">
  <label for="status">Statut *</label>
  <select id="status" name="status" required>
    <option value="brouillon" selected>Brouillon</option>
    <option value="active">Active</option>
    <option value="fermee">Fermée</option>
  </select>
</div>

      <!-- (Facultatif) email de contact d'annonce -->
      <div class="field full">
        <label for="contact_email">Email de contact (optionnel)</label>
        <input
          type="email"
          id="contact_email"
          name="contact_email"
          placeholder="ex. jobs@mon-entreprise.com"
          value="<%= userEmail || '' %>"
        />
        <small class="help">Par défaut, les candidatures vous seront adressées via votre compte.</small>
      </div>
    </div>

    <div class="btnbar">
      <a class="btn btn-secondary" href="/">Annuler</a>
      <button type="submit" class="btn btn-primary" <%= !userHasCompany ? 'disabled' : '' %>>
        Créer l'offre
      </button>
    </div>
  </form>
</main>

<script>
  document.getElementById("create-ad-form").addEventListener("submit", function (e) {
    const min = Number(document.getElementById("salary_min").value || 0);
    const max = Number(document.getElementById("salary_max").value || 0);
    if (min && max && min > max) {
      e.preventDefault();
      alert("Le salaire minimum ne peut pas être supérieur au salaire maximum.");
      return;
    }
  });
</script>